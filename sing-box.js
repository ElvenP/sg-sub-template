const { type , name } = $arguments;

const compatibleOutbound = {
  tag: 'COMPATIBLE',
  type: 'direct',
};

let isCompatibleAdded = false; // ç”¨äºæ£€æŸ¥æ˜¯å¦å·²æ·»åŠ å…¼å®¹é…ç½®
let config = JSON.parse($files[0]); // è§£ææ–‡ä»¶å†…å®¹ä¸º JSON å¯¹è±¡

// ç”Ÿæˆä»£ç†
let proxies = await produceArtifact({
  name,
  type: /^1$|col/i.test(type) ? 'collection' : 'subscription',
  platform: 'sing-box',
  produceType: 'internal',
});

// å°†ç”Ÿæˆçš„ä»£ç†æ·»åŠ åˆ°å‡ºç«™é…ç½®ä¸­
config.outbounds.push(...proxies);

// å®šä¹‰æ ‡ç­¾å’Œå¯¹åº”çš„æ­£åˆ™è¡¨è¾¾å¼æ˜ å°„
const tagRegexMap = {
  æ‰€æœ‰: /.*/, // åŒ¹é…æ‰€æœ‰
  'æ‰€æœ‰-è‡ªåŠ¨': /.*/, // åŒ¹é…æ‰€æœ‰
  'è‡ªå»º': /è‡ªå»º/i, // åŒ¹é…åŒ…å«â€œè‡ªå»ºâ€çš„æ ‡ç­¾
  'è‡ªå»º-è‡ªåŠ¨': /è‡ªå»º/i, // åŒ¹é…åŒ…å«â€œè‡ªå»ºâ€çš„æ ‡ç­¾
  'é¦™æ¸¯': /^(?!.*è‡ªå»º).*?(æ¸¯|hk|hongkong|kong kong|ğŸ‡­ğŸ‡°)/i, // åŒ¹é…â€œé¦™æ¸¯â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'é¦™æ¸¯-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ¸¯|hk|hongkong|kong kong|ğŸ‡­ğŸ‡°)/i, // ä¿®æ”¹ä¸ºä¸â€œé¦™æ¸¯â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å°æ¹¾': /^(?!.*è‡ªå»º).*?(å°|tw|taiwan|ğŸ‡¹ğŸ‡¼)/i, // åŒ¹é…â€œå°æ¹¾â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å°æ¹¾-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å°|tw|taiwan|ğŸ‡¹ğŸ‡¼)/i, // ä¿®æ”¹ä¸ºä¸â€œå°æ¹¾â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'æ—¥æœ¬': /^(?!.*è‡ªå»º).*?(æ—¥æœ¬|jp|japan|ğŸ‡¯ğŸ‡µ)/i, // åŒ¹é…â€œæ—¥æœ¬â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'æ—¥æœ¬-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ—¥æœ¬|jp|japan|ğŸ‡¯ğŸ‡µ)/i, // ä¿®æ”¹ä¸ºä¸â€œæ—¥æœ¬â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'æ–°åŠ å¡': /^(?!.*è‡ªå»º).*?(æ–°|sg|singapore|ğŸ‡¸ğŸ‡¬)/i, // åŒ¹é…â€œæ–°åŠ å¡â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'æ–°åŠ å¡-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ–°|sg|singapore|ğŸ‡¸ğŸ‡¬)/i, // ä¿®æ”¹ä¸ºä¸â€œæ–°åŠ å¡â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'ç¾å›½': /^(?!.*è‡ªå»º).*?(ç¾|us|unitedstates|united states|ğŸ‡ºğŸ‡¸)/i, // åŒ¹é…â€œç¾å›½â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'ç¾å›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(ç¾|us|unitedstates|united states|ğŸ‡ºğŸ‡¸)/i, // ä¿®æ”¹ä¸ºä¸â€œç¾å›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'éŸ©å›½': /^(?!.*è‡ªå»º).*?(éŸ©|kr|korea|ğŸ‡°ğŸ‡·)/i, // åŒ¹é…â€œéŸ©å›½â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'éŸ©å›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(éŸ©|kr|korea|ğŸ‡°ğŸ‡·)/i, // ä¿®æ”¹ä¸ºä¸â€œéŸ©å›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å·´è¥¿': /^(?!.*è‡ªå»º).*?(å·´|br|brazil|ğŸ‡§ğŸ‡·)/i, // åŒ¹é…â€œå·´è¥¿â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å·´è¥¿-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å·´|br|brazil|ğŸ‡§ğŸ‡·)/i, // ä¿®æ”¹ä¸ºä¸â€œå·´è¥¿â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'æ³¢å…°': /^(?!.*è‡ªå»º).*?(æ³¢|pl|poland|ğŸ‡µğŸ‡±)/i, // åŒ¹é…â€œæ³¢å…°â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'æ³¢å…°-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ³¢|pl|poland|ğŸ‡µğŸ‡±)/i, // ä¿®æ”¹ä¸ºä¸â€œæ³¢å…°â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å–€éº¦éš†': /^(?!.*è‡ªå»º).*?(å–€|cm|cameroon|ğŸ‡¨ğŸ‡²)/i, // åŒ¹é…â€œå–€éº¦éš†â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å–€éº¦éš†-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å–€|cm|cameroon|ğŸ‡¨ğŸ‡²)/i, // ä¿®æ”¹ä¸ºä¸â€œå–€éº¦éš†â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'ä¸­éå…±å’Œå›½': /^(?!.*è‡ªå»º).*?(ä¸­é|cf|centralafrican|ğŸ‡¨ğŸ‡«)/i, // åŒ¹é…â€œä¸­éâ€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'ä¸­éå…±å’Œå›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(ä¸­é|cf|centralafrican|ğŸ‡¨ğŸ‡«)/i, // ä¿®æ”¹ä¸ºä¸â€œä¸­éå…±å’Œå›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å“ˆè¨å…‹æ–¯å¦': /^(?!.*è‡ªå»º).*?(å“ˆ|kz|kazakhstan|ğŸ‡°ğŸ‡¿)/i, // åŒ¹é…â€œå“ˆè¨å…‹æ–¯å¦â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å“ˆè¨å…‹æ–¯å¦-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å“ˆ|kz|kazakhstan|ğŸ‡°ğŸ‡¿)/i, // ä¿®æ”¹ä¸ºä¸â€œå“ˆè¨å…‹æ–¯å¦â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'ä¿„ç½—æ–¯': /^(?!.*è‡ªå»º).*?(ä¿„|ru|russia|ğŸ‡·ğŸ‡º)/i, // åŒ¹é…â€œä¿„ç½—æ–¯â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'ä¿„ç½—æ–¯-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(ä¿„|ru|russia|ğŸ‡·ğŸ‡º)/i, // ä¿®æ”¹ä¸ºä¸â€œä¿„ç½—æ–¯â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'è‹±å›½': /^(?!.*è‡ªå»º).*?(è‹±|uk|unitedkingdom|ğŸ‡¬ğŸ‡§)/i, // åŒ¹é…â€œè‹±å›½â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'è‹±å›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(è‹±|uk|unitedkingdom|ğŸ‡¬ğŸ‡§)/i, // ä¿®æ”¹ä¸ºä¸â€œè‹±å›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'ç‘å…¸': /^(?!.*è‡ªå»º).*?(ç‘|se|sweden|ğŸ‡¸ğŸ‡ª)/i, // åŒ¹é…â€œç‘å…¸â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'ç‘å…¸-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(ç‘|se|sweden|ğŸ‡¸ğŸ‡ª)/i, // ä¿®æ”¹ä¸ºä¸â€œç‘å…¸â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'æ³•å›½': /^(?!.*è‡ªå»º).*?(æ³•|fr|france|ğŸ‡«ğŸ‡·)/i, // åŒ¹é…â€œæ³•å›½â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'æ³•å›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ³•|fr|france|ğŸ‡«ğŸ‡·)/i, // ä¿®æ”¹ä¸ºä¸â€œæ³•å›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'è·å…°': /^(?!.*è‡ªå»º).*?(è·|nl|netherlands|ğŸ‡³ğŸ‡±)/i, // åŒ¹é…â€œè·å…°â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'è·å…°-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(è·|nl|netherlands|ğŸ‡³ğŸ‡±)/i, // ä¿®æ”¹ä¸ºä¸â€œè·å…°â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'åŠ æ‹¿å¤§': /^(?!.*è‡ªå»º).*?(åŠ |ca|canada|ğŸ‡¨ğŸ‡¦)/i, // åŒ¹é…â€œåŠ æ‹¿å¤§â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'åŠ æ‹¿å¤§-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(åŠ ca|canada|ğŸ‡¨ğŸ‡¦)/i, // ä¿®æ”¹ä¸ºä¸â€œåŠ æ‹¿å¤§â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'æ¾³å¤§åˆ©äºš': /^(?!.*è‡ªå»º).*?(æ¾³|au|australia|ğŸ‡¦ğŸ‡º)/i, // åŒ¹é…â€œæ¾³å¤§åˆ©äºšâ€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'æ¾³å¤§åˆ©äºš-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(æ¾³|au|australia|ğŸ‡¦ğŸ‡º)/i, // ä¿®æ”¹ä¸ºä¸â€œæ¾³å¤§åˆ©äºšâ€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å°åº¦': /^(?!.*è‡ªå»º).*?(å°|in|india|ğŸ‡®ğŸ‡³)/i, // åŒ¹é…â€œå°åº¦â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å°åº¦-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å°|in|india|ğŸ‡®ğŸ‡³)/i, // ä¿®æ”¹ä¸ºä¸â€œå°åº¦â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'é˜¿è”é…‹': /^(?!.*è‡ªå»º).*?(é˜¿|ae|uae|ğŸ‡¦ğŸ‡ª)/i, // åŒ¹é…â€œé˜¿è”é…‹â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'é˜¿è”é…‹-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(é˜¿|ae|uae|ğŸ‡¦ğŸ‡ª)/i, // ä¿®æ”¹ä¸ºä¸â€œé˜¿è”é…‹â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
  'å¾·å›½': /^(?!.*è‡ªå»º).*?(å¾·|de|germany|ğŸ‡©ğŸ‡ª)/i, // åŒ¹é…â€œå¾·å›½â€ä½†ä¸åŒ¹é…â€œè‡ªå»ºâ€
  'å¾·å›½-è‡ªåŠ¨': /^(?!.*è‡ªå»º).*?(å¾·|de|germany|ğŸ‡©ğŸ‡ª)/i, // ä¿®æ”¹ä¸ºä¸â€œå¾·å›½â€ç›¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
};

// éå†å‡ºç«™é…ç½®å¹¶æ·»åŠ ç›¸åº”çš„ä»£ç†
config.outbounds.forEach(outbound => {
  const regex = tagRegexMap[outbound.tag];

  if (regex) {
    // æ·»åŠ åŒ¹é…çš„ä»£ç†
    outbound.outbounds.push(...getTags(proxies, regex));
  }
});

// ç¡®ä¿æ¯ä¸ªå‡ºç«™é…ç½®éƒ½æœ‰ä»£ç†
config.outbounds.forEach(outbound => {
  if (Array.isArray(outbound.outbounds) && outbound.outbounds.length === 0) {
    if (!isCompatibleAdded) {
      config.outbounds.push(compatibleOutbound);
      isCompatibleAdded = true;
    }
    outbound.outbounds.push(compatibleOutbound.tag);
  }
});

// å°†æœ€ç»ˆçš„é…ç½®è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
$content = JSON.stringify(config, null, 2);

// è·å–æ ‡ç­¾çš„å‡½æ•°
function getTags(proxies, regex) {
  return proxies.filter(p => regex.test(p.tag)).map(p => p.tag);
}
